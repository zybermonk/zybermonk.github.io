<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>The magical window function | Mohan Ramesh</title> <meta name="author" content="Mohan Ramesh"/> <meta name="description" content="Some data analytics with Postgres"/> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"/> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="none" id="highlight_theme_light"/> <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚛️</text></svg>"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://zybermonk.github.io/blog/2022/wf/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"/> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src="/assets/js/distillpub/template.v2.js"></script> <script src="/assets/js/distillpub/transforms.v2.js"></script> <script src="/assets/js/distillpub/overrides.js"></script> <style type="text/css">.fake-img{background:#bbb;border:1px solid rgba(0,0,0,0.1);box-shadow:0 0 4px rgba(0,0,0,0.1);margin-bottom:12px}.fake-img p{font-family:monospace;color:white;text-align:left;margin:12px 0;text-align:center;font-size:16px}</style> </head> <d-front-matter> <script async type="text/json">{
      "title": "The magical window function",
      "description": "Some data analytics with Postgres",
      "written on": "August 15, 2022",
      "authors": [
        {
          "author": "Mohan Ramesh",
          "authorURL": "https://github.com/Neuromancer24",
          "affiliations": [
            {
              "name": "None",
              "url": ""
            }
          ]
        }
        
      ],
      "katex": {
        "delimiters": [
          {
            "left": "$",
            "right": "$",
            "display": false
          },
          {
            "left": "$$",
            "right": "$$",
            "display": true
          }
        ]
      }
    }</script> </d-front-matter> <body class="fixed-top-nav"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Mohan </span>Ramesh</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blogs<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">resume</a> </li> <li class="nav-item "> <a class="nav-link" href="/teaching/">teaching</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> </header> <div class="post distill"> <d-title> <h1>The magical window function</h1> <p>Some data analytics with Postgres</p> </d-title> <d-byline></d-byline> <d-article> <d-contents> <nav class="l-text figcaption"> <h3>Contents</h3> <div><a href="#the-window-function">The window function</a></div> <ul> <li><a href="#1-loading-the-data">1. Loading the Data</a></li> <li><a href="#2-aggregations">2. Aggregations</a></li> <li><a href="#3-row-sequencing-part-1">3. Row-sequencing part 1</a></li> <li><a href="#4-row-sequencing-part-2">4. Row-sequencing part 2</a></li> <li><a href="#5-inter-row-calculations">5. Inter-row calculations</a></li> <li><a href="#6-bonus">6. Bonus!</a></li> </ul> <div><a href="#conclusion">Conclusion</a></div> </nav> </d-contents> <h1 id="the-window-function">The window function</h1> <p>Are you looking to do some data analytics with Postgres, and want to explore some interesting techniques? You are in the right place. There’s a huge list of features that Postgres is offering, and Window functions are a part of this overall offering, basically they are a part of these vast analytical toolsets that Postgres offer.</p> <p><strong>What are these window functions actually?</strong></p> <p>A <a href="https://www.gooddata.com/blog/sql-21st-century-analytic-window-functions/" target="_blank" rel="noopener noreferrer">window function</a>/ an analytical function performs a calculation across a set of table rows that aresomehow related to the current row. That’s kind of obvious and similar to what aggregate functions do, right? Yes and No. There’s a fundamental difference between window functions and other functions, i.e., window functions do not cause rows to become grouped into a single output row like non-window aggregate functions would.</p> <p><strong>Interesting, but how are they useful?</strong></p> <p>Let us look at a small case study to better understand the window functions and their magic! In this article we use a table called ‘topups’ from a database of a small mobile company. We have a flat file in a TSV format. Let us go ahead and import this data.</p> <h2 id="1-loading-the-data">1. Loading the Data</h2> <p>Instead of copying and morphing the data, we keep the integrity of the source data by accessing the data using a foreign table, which is one of the many ways to access remote data. To do this we make use of an extension called file_fdw, which is a module that provides foreign data wrapper tool.</p> <div> <figure> <picture> <img src="/assets/img/posts/wf1.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>Once the extension is installed we can easily create a table by accessing the data from the remote server we just created. However, we need to make sure the column are defined exactly as in the source database. The syntax looks something as below.</p> <div> <figure> <picture> <img src="/assets/img/posts/wf2.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>Now, we can either copy this to a new table or directly access data from this foreign table.</p> <h2 id="2-aggregations">2. Aggregations</h2> <p>The data we are about to access looks something like this,</p> <div> <figure> <picture> <img src="/assets/img/posts/wf3.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>There are different types of window functions, and can be grouped into the following,</p> <ul> <li>Aggregate Window Functions SUM (), MAX (), MIN (), AVG (), COUNT ()</li> <li>Ranking Window Functions RANK (), DENSE_RANK (), ROW_NUMBER (), NTILE ()</li> <li>Value Window Functions LAG (), LEAD (), FIRST_VALUE (), LAST_VALUE ()</li> </ul> <p>We take a look at some of the window functions and their examples using our foreign table, ‘topups’</p> <p><code class="language-plaintext highlighter-rouge">Listing the total of ALL topups done by a user, if they have ever had a top up of exactly € 15 </code> The first thought in our mind would be to use a select query to get all the users (id_user) who have had a top up of € 15 and any top ups other than €15. This requires a nested select query and a join operation. But can also be done using a single select statement, however, this only works if and only if we know that all the users have at least once done a €15 top up.</p> <div> <figure> <picture> <img src="/assets/img/posts/wf4.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>The previous code results in an output as below</p> <div> <figure> <picture> <img src="/assets/img/posts/wf5.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>In the above example we have assumed that all users have made a top up of €15 at least once, but what if we did not have this information?</p> <p>So, what do we do now? We go for aggregate functions! (Traditionally)</p> <div> <figure> <picture> <img src="/assets/img/posts/wf6.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>Output will be like below</p> <div> <figure> <picture> <img src="/assets/img/posts/wf5.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>We can clearly see that simple aggregate function can solve this problem. But why do we need the window function? Just look at the code above, its long, confusing for other people and its messy. Hence, we will try to solve the same problem by using the window function and see for ourselves, the magic of window functions!</p> <p><strong>Take a look at this snippet of code below</strong></p> <div> <figure> <picture> <img src="/assets/img/posts/wf7.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>WOW! What happened here. The query length is reduced to less than half and this also keeps the identity of each row, allowing us an access to the gateway for plenty of analysis which previously was hindered due to the usage of mere aggregate functions.</p> <div> <figure> <picture> <img src="/assets/img/posts/wf8.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>For example, the date column has still maintained its integrity when we use a window function, which is a huge advantage while doing several data analytics tasks which we will see further in this article.</p> <p>SQL window functions, as demonstrated in this article, are a powerful notion that enables for sophisticated computations. A typical window function consists of an expression and a window specification, with optional partitioning and a frame clause, and the possibilities for slicing, smoothing, interconnecting, and deduplicate data are virtually limitless. There are plenty of interesting use cases where these functions give a great value. We’ll continue talking about them in the next few sections. Stay tuned!</p> <h2 id="3-row-sequencing-part-1">3. Row-sequencing part 1</h2> <p><code class="language-plaintext highlighter-rouge">Displaying latest top 5 top ups for each user</code></p> <p>The first thought now would be… definitely a lot of subqueries and join operations. Very tedious! But also, using the general aggregate functions would combine the rows and output a single row. If we recall the introduction section of this article, we can say this is where the magic of window functions happens. We make use of Ranking window functions to solve this problem and still display individual rows for each operation.</p> <p><strong>Consider the code snippet below</strong></p> <div> <figure> <picture> <img src="/assets/img/posts/wf9.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>The output will be something like this</p> <div> <figure> <picture> <img src="/assets/img/posts/wf.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>Same date but ranked in decreasing order of top up value</p> <p>We successfully completed the task 3 by using a combination of a few window functions, which are easy to read, understand and debug!</p> <h2 id="4-row-sequencing-part-2">4. Row sequencing part 2</h2> <p><code class="language-plaintext highlighter-rouge">Displaying Top 5 largest topups by each user, while retaining the immediately following topups if the subsequent values are same</code></p> <p><strong>Consider the code snippet below</strong></p> <div> <figure> <picture> <img src="/assets/img/posts/wf10.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>The output will be as follows</p> <div> <figure> <picture> <img src="/assets/img/posts/wf11.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>Just by altering a few lines, we now have solved task too. That is the power of window functions!</p> <h2 id="5-inter-row-calculations">5. Inter-row calculations</h2> <p><code class="language-plaintext highlighter-rouge">Creating a new table using the original table by adding additional columns</code></p> <p>We can easily create a new table from an existing dataset whilst creating new columns using the operations performed on the older tables’ columns. Window functions, as opposed to aggregation, return a result for each row. You can use window functions in a Custom Formula transformation of a Data Prep recipe.</p> <p><strong>Consider the code snippet below</strong></p> <div> <figure> <picture> <img src="/assets/img/posts/wf12.jpeg" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>The new table created looks like below</p> <div> <figure> <picture> <img src="/assets/img/posts/wf13.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <h2 id="6-bonus">6. Bonus!</h2> <p>Now to the final task! We use all the knowledge gained till now and use it all to solve a single problem. Let us consider a Promotion scheme run by our mobile company. The gift is a free credit for 28 days if a user tops up by €20 or more. Promotion will be applied the same day of the top up immediately. So, we need to find the users who are eligible for the promotion and their promotion period. Promotion can be availed multiple time too!</p> <div> <figure> <picture> <img src="/assets/img/posts/wf14.jpeg" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>So, what will be our approach to solve this? A good approach will be to filter out topups which are €20 or more for each user and compute the difference between their subsequent latest topups. Then setting flags for start and end period will further help us to filter only those which fall in the 28 - day period (for every start period +28 is added to get end period). Then we can sort individual users who are eligible, and we have our desired output!</p> <p>The output will be as follows</p> <div> <figure> <picture> <img src="/assets/img/posts/wf15.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <h1 id="conclusion">Conclusion</h1> <div> <figure> <picture> <img src="/assets/img/posts/wfm.jpeg" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>Basically, window functions are very powerful!</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Source: https://www.toptal.com/sql/intro-to-sql-windows-functions
</code></pre></div></div> <p>While this is a brief overview of PostgreSQL window functions, perhaps it has piqued our curiosity in learning more about what they can accomplish. We discovered that window functions execute calculations in the same way as aggregation functions do, but with the extra bonus of having access to data within individual rows, making them extremely powerful. Also, the window functions only need one sequential scan of the table and regular joins need 2 sequential scans of the table values.</p> <p>They always contain the OVER clause, and may contain PARTITION BY, ORDER BY, and a host of aggregating (SUM, COUNT, etc.) and other positional functions (LEAD, LAG). We also learned about window frames and how they encapsulate sections of data.</p> </d-article> <d-appendix> <d-footnote-list></d-footnote-list> <d-citation-list></d-citation-list> </d-appendix> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Mohan Ramesh. </div> </footer> <d-bibliography src="/assets/bibliography/"></d-bibliography> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> </body> </html>